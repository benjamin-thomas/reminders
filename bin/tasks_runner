#!/usr/bin/env ruby

require 'find'
require 'logger'
require 'open3'

logger = Logger.new(STDOUT)
SLEEP_FOR = 60*60*4

TASKS_PATH = ENV.fetch('TASKS_PATH')
loop do
  logger.info('[START] loop')
  TASKS_PATH.split(':').each do |tpath|
    Find.find(tpath) do |path|
      next if !File.file?(path)

      stdout, stderr, status = Open3.capture3(path)
      next if status.exitstatus == 0

      msg = "FAIL: #{File.basename(path)} err=#{stderr}"
      # `normal` + --expire-time does not work properly, stay sticky with `critical`
      system('notify-send', '-u', 'critical', msg)

    end
  end

  logger.info("[START] sleep, next run at: #{Time.now + SLEEP_FOR}")
  sleep(SLEEP_FOR)
end
